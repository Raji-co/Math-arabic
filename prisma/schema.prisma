generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// A platform user: either an admin or a contributor
model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         String   @default("contributor") // 'admin' | 'contributor'
  createdAt    DateTime @default(now())

  // Content authored by this user
  nodes        Node[]
}

// A Node is any piece of content or structural item in the platform
model Node {
  id          String   @id @default(cuid())
  type        String   // 'topic' | 'article' | 'video' | 'applet' | 'exercise'
  title       String
  description String?
  content     String?  // JSON string of Serlo Editor state (for articles/exercises)
  url         String?  // For videos and applets
  status      String   @default("draft") // 'draft' | 'pending' | 'published'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Author (contributor or admin who created this node)
  author      User?    @relation(fields: [authorId], references: [id], onDelete: SetNull)
  authorId    String?

  // Taxonomy links - this node as a child
  asChild     TaxonomyLink[] @relation("childLinks")
  // Taxonomy links - this node as a parent
  asParent    TaxonomyLink[] @relation("parentLinks")

  // Curriculum tags
  tags        CurriculumTag[]
}

// Defines the parent-child hierarchy between nodes
model TaxonomyLink {
  id       String @id @default(cuid())
  parent   Node   @relation("parentLinks", fields: [parentId], references: [id], onDelete: Cascade)
  parentId String
  child    Node   @relation("childLinks", fields: [childId], references: [id], onDelete: Cascade)
  childId  String

  @@unique([parentId, childId])
}

// Tags a node to a specific country and grade (regional curriculum mapping)
model CurriculumTag {
  id      String @id @default(cuid())
  node    Node   @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  nodeId  String
  country String // e.g. 'SA', 'JO', 'EG', 'ALL'
  grade   Int
  subject String
}
